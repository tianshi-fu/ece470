clear
clc

q_in1 = [1.61346405 -2.18747393 -1.23918201 -0.81633896 0.57693787 0.57805663 -0.77671805 1.99738056 0.03622310 -2.11999037 0.93520581 2.38110637; -1.15244090 -0.86813258 -0.46796391 -0.49125080 -2.12345809 1.17313452 1.03833862 -0.66685764 0.12826900 -1.49186775 0.38123132 -0.11237915; 0.31346480 2.96886854 0.18147870 0.53110854 -0.37342460 0.62129680 -1.90331954 0.07380918 1.53027546 -0.87402337 0.87710020 0.48975406; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];
q_in0 = [1.47184713 -2.39562310 -0.82793163 -0.76054343 0.72819914 -1.05536913 -0.54885045 1.67193130 -1.11973050 -0.56469499 -0.00199957 0.99814300; 0.47342962 -2.40074941 -0.59847991 -0.32615078 -0.29749426 1.24469536 2.36245927 1.25975852 -0.47392315 -1.56677438 0.92505729 1.78023451; 1.11887307 2.19449107 0.99523578 0.65681780 -0.33001313 0.31135158 -2.61985354 0.30898930 2.26954349 -2.20238414 1.41599159 1.07817027; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];


n = 2;
trials = 1;
[~,npoints]=size(q_in0);


while trials < 51
rng shuffle
[R,~]=qr(randn(3));
posi = randn(3,1);
M = [R posi; 0 0 0 1];

tic

while n > 1e-10
  
   for c = 1:npoints
   [A{c},B{c},error{c}]=calc_b_j(M,q_in0(:,c),q_in1(:,c)); 
   end
   
   sum_A = sum(cat(3,A{:}),3);
   sum_B = sum(cat(3,B{:}),3);
   sum_error = sum(cat(3,error{:}),3);
   
   u = inv(sum_A+0.01*eye(6)) * sum_B;
   
   M = expm(ss61(u))*M;           
   n=sum_error;
  
   Ms{trials} = M;
    
   nu(trials) = norm(u);
  
   e = toc;
   
   if e > 0.5
       
       break
   end
    
   
end
disp(trials)
errors(trials) = sum_error;
trials = trials + 1;
end
[~,min_ind]=min(errors);
min_m = Ms{min_ind};
disp(mat2str(min_m))