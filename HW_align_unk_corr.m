clear
clc

q_in1 = [0.23300971 -0.57095524 -0.50162790 -0.41335819 1.70973719 -0.08932141 -1.31551618 0.74833482 0.97574168 0.30255237; -0.83907338 1.14509106 -0.31088938 0.82976981 0.39974246 0.96804271 2.92974290 -0.17600088 -0.16317516 -1.17505277; 0.92384738 -0.50613888 0.28318377 -0.36580053 0.07305417 1.00352947 1.91266293 0.11480250 1.88544859 -1.28719487; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];
q_in0 = [0.53879671 -1.12571225 -0.73028650 -0.72517446 -4.17833527 -1.17037975 -2.32254402 -1.24733284 -1.43293837 -2.34524433; -1.50339289 0.33368665 -1.24402237 -0.91109124 0.99016525 -0.00026374 -2.08214877 -1.34569341 -2.11376295 -0.53660139; -0.34894381 -0.43736051 0.46177401 1.64509990 -0.09206249 -0.45385560 1.14058403 -0.53024708 0.09080849 0.33892939; 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000 1.00000000];

rng shuffle
% [R,~]=qr(randn(3));
% posi = randn(3,1);
% M = [R posi; 0 0 0 1];
 M = eye(4);

n = 2;
[~,npoints]=size(q_in0);
sum_A = zeros(6);
sum_B = zeros(6,1);


while n > 1e-12
   
   for x = 1:npoints
   index{x} = min_norm(M,q_in0(:,x),q_in1);
   end
    
    
    
   for c = 1:npoints
   [A{c},B{c}]=calc_b_j(M,q_in0(:,c),q_in1(:,index{1,c}));
   end
   sum_A = sum(cat(3,A{:}),3);
   sum_B = sum(cat(3,B{:}),3);
   
   
   u = inv(sum_A+0.25*eye(6)) * sum_B;
   
   
   
   M = expm(ss61(u))*M;           
   n=norm(u);
   
    disp(n)
    
end
disp(mat2str(M,5));